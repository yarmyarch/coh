var coh=coh||{};coh.res={HelloWorld_png:"res/HelloWorld.png",CloseNormal_png:"res/CloseNormal.png",CloseSelected_png:"res/CloseSelected.png",map:{forest:{tmx:"res/tmxmap/forest.tmx",img:"res/tmxmap/forest.jpg"},market:{tmx:"res/tmxmap/b_market.tmx",img:"res/tmxmap/b_market.jpg"}},sprite:{awen:{walking:{plist:"res/sprite/sprite.plist",img:"res/sprite/sprite.png"}}}};(function(){var a=function(d){var b=[];for(var c in d){if(d[c] instanceof Object){b=b.concat(a(d[c]))}else{b.push(d[c])}}return b};coh.resources=a(coh.res)})();var coh=coh||{};coh.LocalConfig={COLOR:{GREEN:1,RED:2,BLUE:3},LOCATION_TYPE:{1:[1,1],2:[2,1],3:[1,2],4:[2,2]},CONVERT_TYPE:{1:[[1],[1],[1]],2:[[2],[2],[1],[1]],3:[[1,1,1]],4:[[3,3],[1,1]],5:[[4,4],[4,4],[1,1],[1,1]]},BLANK:0,COLOR_COUNT:3,BLANK_DATA_GROUP:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],FRAME_RATE:0.1,COLOR_CONFIG:{elf:["blue","white","gold"]}};var SlideUtil=(function(){var d,a=arguments;var e={interval:false,slides:false,newInstance:false,oriSlides:false};var f={FLOAT_RANGE:0.00002,PARAM:{START:0,END:1,SPEED:2,INTERVAL:3,CALLBACK:4}};var c={getDivisor:function(h,g){if(h<g){var i;i=h;h=g;g=i}while(g!=0){i=h%g;h=g;g=i}return h}};var b={judge:function(h){var g=f;h[g.PARAM.START]=+h[g.PARAM.START];h[g.PARAM.END]=+h[g.PARAM.END];h[g.PARAM.SPEED]=+h[g.PARAM.SPEED];h[g.PARAM.INTERVAL]=Math.abs(+h[g.PARAM.INTERVAL]);h[5]&&(h[5]=+h[5]);h[g.PARAM.INTERVAL]=Math.ceil(h[g.PARAM.INTERVAL]/17)*17;if(isNaN(Math.max(h[g.PARAM.START],h[g.PARAM.END],h[g.PARAM.SPEED],h[g.PARAM.INTERVAL]))){return false}return h},slide:function(){var n=[],o=0,l=e,h=f,m=e.slides=[];var j;for(var k=0,g=arguments.length;k<g;++k){j=b.judge(arguments[k]);if(!j){continue}m.push(j);o=o||j[h.PARAM.INTERVAL];o=c.getDivisor(o,j[h.PARAM.INTERVAL])}l.newInstance&&(l.oriSlides=m);clearInterval(l.interval);m.length&&(l.interval=setInterval(function(){var r=[],q=true,t=false;for(var s=0,p=m.length;s<p;++s){if(o%m[s][h.PARAM.INTERVAL]!=0||n[s]){q=q&&!!n[s];continue}r[s]=m[s][h.PARAM.END]-m[s][h.PARAM.START];if(r[s]==0||Math.abs(r[s])<=m[s][5]||Math.abs(r[s])<=f.FLOAT_RANGE){n[s]=1;q=q&&!!n[s];(m[s][h.PARAM.CALLBACK] instanceof Function)&&m[s][h.PARAM.CALLBACK](m[s][h.PARAM.END],r[s],!!n[s]);continue}else{n[s]=0;q=q&&!!n[s]}t=m[s][h.PARAM.START]===~~m[s][h.PARAM.START]&&m[s][h.PARAM.END]===~~m[s][h.PARAM.END];m[s][h.PARAM.START]=m[s][h.PARAM.START]+r[s]*m[s][h.PARAM.SPEED];t&&(m[s][h.PARAM.START]=r[s]>0?Math.ceil(m[s][h.PARAM.START]):Math.floor(m[s][h.PARAM.START]));(m[s][h.PARAM.CALLBACK] instanceof Function)&&m[s][h.PARAM.CALLBACK](m[s][h.PARAM.START],r[s],!!n[s])}o+=o;q&&clearInterval(l.interval)},o));l.newInstance=false}};d=function(){var g=e;g.newInstance=1;g.slides=a};d.pause=function(){clearInterval(e.interval)};d.run=function(){var g=e;!!arguments.length&&(g.newInstance=1);if(arguments&&arguments.length){b.slide.apply({},arguments)}else{b.slide(g.slides)}};d.restore=function(){var j=e,g=f;for(var h in j.oriSlides){j.slides[g.PARM.END]=j.oriSlides[g.PARM.START]}b.slide(j.slides)};d.clear=function(){var j=e,g=f;for(var h in j.oriSlides){j.slides[g.PARM.START]=j.oriSlides[g.PARM.START]}};return d})();var coh=coh||{};coh.View=(function(){var a;var b={spriteCache:cc.spriteFrameCache};return a={moveMap:function(c,i){var h=coh.map,e=h.getPosition(),g=false,d=false;var f=function(){g&&d&&i&&i()};SlideUtil.run([e.x,c.x,0.3,40,function(l,j,k){h.setPosition(l,h.getPosition().y);g=k;f()},0.5],[e.y,c.y,0.3,40,function(l,j,k){h.setPosition(h.getPosition().x,l);d=k;f()},0.5])},setSprite:function(){},locateNode:function(d){var e=coh.map,c=cc.director.getWinSize();e.setPosition(-d.x-d.width/2+c.width/2,-d.y-d.height/2+c.height/2)},moveMapToNode:function(d,f){var e=coh.map,c=cc.director.getWinSize();a.moveMap({x:-d.x-d.width/2+c.width/2,y:-d.y-d.height/2+c.height/2},f)},getSprite:function(c,l,d){var j=[],f,g,n,k=coh,e=b.spriteCache;var m={rate:d.rate||k.LocalConfig.FRAME_RATE,constructor:d.constructor||cc.Sprite,color:d.color===undefined?-1:d.color};e.addSpriteFrames(k.res.sprite[c][l].plist,k.res.sprite[c][l]["img"+(m.color===-1?"":"_"+(+m.color))]);for(var h in e._spriteFrames){j.push(e._spriteFrames[h])}f=cc.Animation.create(j,m.rate);g=cc.RepeatForever.create(cc.Animate.create(f));var n=new m.constructor(j[0],null);n.runAction(g);return{sprite:n,action:g}}}})();var coh=coh||{};coh.Actor=cc.Sprite.extend({position:"",ctor:function(c,d,b){this._super(c,d);this.position=b.name;coh.View.locateNode(b);var a=cc.director.getWinSize();this.setPosition(a.width/2,a.height/2+this.height/4)},goTo:function(b,c){var a=this;a.position="";coh.View.moveMapToNode(b,function(){a.position=b.name;c&&c()})}});var coh=coh||{};coh.Battle=(function(){var b;var e=coh.LocalConfig;var c={occupiedRowIndex:{}};var d={locationTest:{1:function(g,f){return +g[g.length-1][f]==e.BLANK},2:function(g,f){return +g[g.length-1][f]==e.BLANK&&g[g.length-2][f]==e.BLANK},3:function(g,f){return +g[g.length-1][f]==e.BLANK&&+g[g.length-1][f+1]==e.BLANK},4:function(g,f){return +g[g.length-1][f]==e.BLANK&&+g[g.length-1][f+1]==e.BLANK&&+g[g.length-2][f]==e.BLANK&&+g[g.length-2][f+1]==e.BLANK}}};var a={getBlankIndex:function(h,f){var j=e.BLANK;for(var g=h.length-1;g>=0;--g){if(+h[g][f]!=j){return g+1}}return 0},findConvert:function(f,g,p,h){var q=e,o,l,s=[];for(var k in q.CONVERT_TYPE){o=q.CONVERT_TYPE[k];l=true;if(o.length>p+1||o[0].length>g+1){continue}for(var n=o.length-1,m;m=o[n];--n){for(var r=m.length-1,j;j=m[r];--r){if(n==o.length-1&&r==m.length-1){continue}j=j*q.COLOR_COUNT+h;l=l&&(+j==+f[p+1-o.length+n][g+1-m.length+r]);if(!l){break}}if(!l){break}}if(l){s.push(k)}}return s},locationTest:function(h,g,f){return d.locationTest[g](h,f)},colorTest:function(i,h,g,f){if(h!=1){return true}if(b.findAllPossibleConverts(i,g,a.getBlankIndex(i,g),f).length){return false}return true},checkResultSet:function(i,j,g){var h=c;if(!i[h.occupiedRowIndex[g]]){var f=0;while(f<=h.occupiedRowIndex[g]){i.push(j.join(" ").replace(/\d+/g,0).split(" "));++f}}return i},copy2Array:function(f){var h=f.concat();for(var g=0,j;j=f[g];++g){h[g]=h[g].concat()}return h}};return b={generate:function(g,f){},recharge:function(q,x){var n=[],f=[],o=a.copy2Array(q);totalCount=0,items=[],_lc=e,_buf=c,_util=a;for(var u in x){totalCount+=x[u];for(var t=0;t<x[u];++t){items.push(u)}}var y,s,v=o[0].length,g,w,r,h,k=true;_buf.occupiedRowIndex={};while(items.length>0){y=~~(Math.random()*items.length);s=items[y];if(!_lc.LOCATION_TYPE[s]){continue}items[y]=items[items.length-1];items.length=items.length-1;w=0;h=0;do{if(w==0){g=~~(Math.random()*v)}else{g=(g+1)%v}++w}while(w<=v&&!(k=_util.locationTest(o,s,g)));if(k){do{if(h==0){r=~~(Math.random()*_lc.COLOR_COUNT)}else{r=(r+1)%_lc.COLOR_COUNT}++h}while(h<=_lc.COLOR_COUNT&&!(k=_util.colorTest(o,s,g,r)))}if(!k){f.push(s)}else{var l=_lc.LOCATION_TYPE[s],p=0;for(var m=0;m<l[0];++m){for(var w=0;w<l[1];++w){p=Math.max(p,_util.getBlankIndex(o,g+w))}for(var w=0;w<l[1];++w){if(!_buf.occupiedRowIndex[g+w]){_buf.occupiedRowIndex[g+w]=0}n=_util.checkResultSet(n,o[0],g+w);n[_buf.occupiedRowIndex[g+w]][g+w]=o[p][g+w]=s*_lc.COLOR_COUNT+r;++_buf.occupiedRowIndex[g+w]}}}}return{succeed:n,faild:f,dataGroup:o}},findAllPossibleConverts:function(f,g,n,j){var h=g,l,p=[],o=e,i=a,k=1*o.COLOR_COUNT+j,m=i.copy2Array(f);m[n][g]=k;while(h>=0&&+m[n][h]==+k){l=i.findConvert(m,h,n,j);l.length&&p.push({column:h,row:n,converts:l});--h}h=g+1;while(h<m[0].length&&+m[n][h]==+k){l=i.findConvert(m,h,n,j);l.length&&p.push({column:h,row:n,converts:l});++h}return p}}})();var coh=coh||{};coh.MapScene=cc.Scene.extend({onEnter:function(){this._super();var a=new coh.MapLayer();this.addChild(a)}});var coh=coh||{};coh.MapLayer=cc.Layer.extend({sprite:null,ctor:function(){this._super();var f=coh;f.map=cc.TMXTiledMap.create(f.res.map.forest.tmx);this.addChild(f.map,0,1);var c=cc.director.getWinSize(),b=this,e=f.map.getObjectGroup("positions"),g={},d=function(i){var h;if((h=e.objectNamed(b.sprite.position))&&(h=h[g[i]])&&(h=e.objectNamed(h))){b.sprite.goTo(h,function(){if(h.passingBy){setTimeout(function(){d(i)},0)}})}else{return}},a=function(){cc.director.runScene(cc.TransitionFadeDown.create(1.2,f.scene.battle||(f.scene.battle=new f.BattleScene())));f.scene.battle.generate()};g[cc.KEY.left]="left";g[cc.KEY.right]="right";g[cc.KEY.up]="up";g[cc.KEY.down]="down";if(cc.sys.capabilities.hasOwnProperty("keyboard")){cc.eventManager.addListener({event:cc.EventListener.KEYBOARD,onKeyPressed:function(h,i){if(h==cc.KEY.left||h==cc.KEY.right||h==cc.KEY.up||h==cc.KEY.down){d(h)}if(h==cc.KEY.enter){a()}},onKeyReleased:function(h,i){}},this)}b.sprite=f.View.getSprite("awen","walking",{constructor:function(h,i){return new f.Actor(h,i,e.objectNamed("first"))}}).sprite;this.addChild(b.sprite);return true}});var coh=coh||{};coh.BattleScene=cc.Scene.extend({bgLayer:null,onEnter:function(){this._super();this.bgLayer=new cc.Layer();var c=coh,b=cc.TMXTiledMap.create(c.res.map.market.tmx),a=cc.director.getWinSize(),d=0;this.bgLayer.addChild(b,0,1);b.setAnchorPoint(0.5,0.5);b.setScale(a.height/b.height);b.setPosition(a.width/2,a.height/2);c.map2=b;this.addChild(this.bgLayer)},generate:function(){var a=new coh.Player("",1,{archer:24});this.placePlayer(a);console.log("Go!")},placePlayer:function(k){var m={},f=k.getUnits(),e=coh;var g;for(var a in f){g=e.Unit.getType(a);m[g]||(m[g]=0);m[g]+=f[a].length}var h=e.Battle.recharge(e.LocalConfig.BLANK_DATA_GROUP,m);for(var d=0,l;l=h.succeed[d];++d){for(var c=0,b;b=l[c];++c){this.placeUnit(k,b,d,c)}}},placeUnit:function(c,a,e,b){var d=coh.View.getSprite("archer","idle",{color:a%coh.LocalConfig.COLOR_COUNT});this.bgLayer.addChild(d)}});